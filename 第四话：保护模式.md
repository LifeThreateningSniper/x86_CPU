# 保护模式

## 1 全局描述符表（GDT）

### 1.1 由来

​		我们知道，为了让程序在内存中能自由浮动而又不影响它的正常执行，处理器将内存划分成逻辑上的段，并在指令中使用段内偏移。在保护模式下，对内存的访问仍然使用段地址和偏移地址，但是，在每个段能够访问之前，必须先进行登记。**所以每个段都需要一个描述符，每个段描述符需要用8字节来描述**。为了存放这些描述符，需要在内存中开辟出一段空间。在这段空间里，所有的描述符都是挨在一起集中存放的，这就构成了一个描述符表，也就是全局描述符表（GDT）。

​		**在进入保护模式前，必须要定义全局描述符表**：

理论上，全局描述符表可以位于内存中的任何地方。但是，由于在进入保护模式之后，处理器要立即按新的内存访问模式工作，所以，必须在进入保护模式之前定义GDT。但是，**由于在实模式下只能访问1MB的内存**，故GDT通常都定义在1MB以下的内存范围中。**当然，允许在进入保护模式之后换个位置重新定义GD**T。

### 1.2 全局描述符寄存器（GDTR）

![image-20230410230442842](C:\Users\威威\AppData\Roaming\Typora\typora-user-images\image-20230410230442842.png)

​																										图1 全局描述符寄存器

​		如图1，该寄存器是处理器内部有一个48位的寄存器。共分为两部分，分别是32位的线性地址和16位的边界。32位的处理器具有32根地址线，可以访问的地址范围是0x00000000到0xFFFFFFFF，即4GB内存。所以，**GDTR的32位线性基地址部分保存的是GDT存放在内存中的起始线性地址，16位边界部分保存的是全局描述符表的边界**（界限），其在数值上等于表的大小（总字节数）减一。

​		16位边界如何理解：代表的是GDT表在内存中的偏移线性地址，最大为2^16字节，也就是说该表最大占64KB内存。又因为一个描述符占8字节，故最多可以定义66536/8=8192个描述符。

​		**cpu如何查GDT表：<font color="red">通过读取GDTR寄存器，得到GDT表其实线性地址+低16位中的偏移，来得出某一个段描述符的内存地址。从而读取这个段描述符信息。</font>**

​									                         <img src="C:\Users\威威\AppData\Roaming\Typora\typora-user-images\image-20230410232022233.png" alt="image-20230410232022233" style="zoom:67%;" />		

​																										图2 GDTR与GDT的关系

### 1.3 段描述符

每个描述符在GDT中占8字节，共64bits。下面详细说说每个bit的详细含义：

**段基地址（32bits）**：可以是0～4GB范围内的任意地址，不过，还是建议应当选取那些16字节对齐的地址。尽管对于INTEL处理器来说，允许不对齐的地址，但是，对齐能够使程序在访问代码和数据时的性能最大化。

**段界限（20bits)**：用来指定段的边界，实际上也决定了段的大小。因为访问内存的方法是用段基地址加上偏移量。

**DPL（2bits）**：表示描述符的特权级(Descriptor Privilege Level, DPL)。共有4种处理器支持的特权级别，分别是0、1、2、3，其中0是最高特权级别，3是最低特权级别。特权级是一个数字，可以赋给一个程序，用来决定该程序能够执行哪些指令，或者能够访问哪些系统资源；也可以赋给系统资源，用来决定哪些程序可以访问它们。在这里，描述符的特权级用于指定要访问该段所必须具有的最低特权级。如果这里的数值是2，那么，只有特权级别为0、1和2的程序才能访问该段，而特权级为3的程序访问该段时，处理器会予以阻止。

![](C:\Users\威威\AppData\Roaming\Typora\typora-user-images\image-20230415175120718.png)

​																											图3 段描述符

## 2 保护模式下的内存访问方式

### 2.1 实模式下的内存访问方式

先回顾下实模式下的内存访问方式：采用“段+偏移”的方式，即“段基址：段内偏移地址”，那么真实的物理地址就是为段基址\*16（左移4位） + 段内偏移地址。

### 2.2 32位处理器的段寄存器

8086处理器的段寄存器是16位的，共有4个：CS、DS、ES和SS。而在32位处理器内，在原先的基础上又增加了两个段寄存器FS和GS。

在32位处理器上，这6个段寄存器还各自包括一个不可见的部分，叫作描述符高速缓存器，用来存放段的线性基地址、段界限和段属性。既然不可见，那就是处理器不希望我们访问它。事实上，我们也没有任何办法来访问这些不可见的部分，它是由处理器内部使用的。如下图：

<img src="C:\Users\威威\AppData\Roaming\Typora\typora-user-images\image-20230415214747428.png" alt="image-20230415214747428" style="zoom: 80%;" />

​																						图4 32位处理器内的段寄存器

### 2.3 内存访问方式

​		在保护模式下，段寄存器CS、DS、ES、FS、GS和SS用作段选择器。在保护模式下，尽管访问内存时也需要指定一个段，但传送到段寄存器的内容不是逻辑段地址，**而是段描述符在描述符表中（GDT）的索引号（段选择子）。**

​		在保护模式下访问一个段时，传送到段寄存器的是段选择子。它由三部分组成，第一部分是描述符的索引号，用来在描述符表（GDT）中选择一个段描述符。TI是描述符表指示器(Table Indicator)，TI=0时，表示描述符在GDT中；TI=1时，描述符在LDT中。RPL是请求特权级，表示给出当前选择子的那个程序的特权级别，正是该程序要求访问这个内存段。每个程序都有特权级别。下图5是段选择子的组成：

​		段描述符索引值共13位，则可以索引213 = 8192个描述符，也就是说全局描述符表中最多可以有8192个描述符。

![image-20230415220457649](C:\Users\威威\AppData\Roaming\Typora\typora-user-images\image-20230415220457649.png)

​																					     图5 段选择子的组成

​		下图6，介绍了段选择器和描述符高速缓存器的加载过程。

![image-20230415221054813](C:\Users\威威\AppData\Roaming\Typora\typora-user-images\image-20230415221054813.png)

​																												图6

































